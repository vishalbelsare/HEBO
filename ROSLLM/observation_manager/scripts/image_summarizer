#!/usr/bin/env python3
import rospy
from pathlib import Path

from std_msgs.msg import String
from sensor_msgs.msg import Image as ROSImage
from rosllm_srvs.srv import VLM, VLMRequest

prompt_template = """
You are an image summarizer.

The following is a description of the image source/context:
{image_description}

Please provide a concise, helpful summary of the single latest image frame. 
Focus on the most salient details (objects, scene, text, notable features, anomalies) 
and keep the summary short.
"""

class ImageSummarizerNode:
    def __init__(self):
        rospy.init_node("image_summarizer_node")

        # Params
        self.hz = float(rospy.get_param("~hz", 1.0))  # default 1 Hz
        self.image_description_path = rospy.get_param("~image_description_path", "")
        self.image_description = ""
        if self.image_description_path:
            try:
                self.image_description = Path(self.image_description_path).read_text()
            except Exception as e:
                rospy.logwarn(f"Failed to read image_description_path '{self.image_description_path}': {e}")

        # Keep ONLY the latest image
        self.latest_image = None

        # Subscribe to 'image' (can be remapped)
        rospy.Subscriber("image", ROSImage, self.image_callback, queue_size=1)
        self.pub = rospy.Publisher("image_summary", String, queue_size=10)

        # Timer to summarize at ~hz
        rospy.Timer(rospy.Duration(1.0 / max(self.hz, 1e-6)), self.summarize_image)

        rospy.loginfo("image_summarizer_node initialized. Waiting for images...")

    def image_callback(self, msg: ROSImage):
        self.latest_image = msg

    def summarize_image(self, _event):
        if self.latest_image is None:
            rospy.logwarn_throttle(10.0, "No image received yet; cannot summarize.")
            return

        prompt = prompt_template.format(
            image_description=self.image_description if self.image_description else "(no additional description provided)"
        )

        req = VLMRequest()
        req.prompt = prompt
        req.image = self.latest_image

        try:
            rospy.wait_for_service("call_vlm", timeout=10.0)
            vlm_service = rospy.ServiceProxy("call_vlm", VLM)
            resp = vlm_service(req)
            self.pub.publish(String(data=resp.response.response))
        except Exception as e:
            rospy.logerr(f"Failed to summarize image: {e}")

    def spin(self):
        rospy.spin()


def main():
    ImageSummarizerNode().spin()


if __name__ == "__main__":
    main()
